## Trip Planner Backend (Nestjs, Docker, PostgreSQL)
 

 #### Steps to run locally 🏡: 
** Settings are found in docker-compose.yml
 1. terminal> `docker compose up dev-db -d `
   - To check the container is successfully running:
      -  `docker ps`
   - Check to see if database is running in docker
     - `docker logs $LogNumberGoesHere`
2. How to access and connect to the Database
    - There are lot's of different ways to do this but for this Prisma will be used. 
  - Install two libs: PrismaCLIand Prisma Client(Here the JavaScript one is used ) 
  - `yarn add -D prisma`
  - `yarn add @prisma/client`
  - Run Prisma CLI (will auto generate some files): `npx prisma init`
  - update the DATABASE_URL found in the autogenerated .env 

3. Add data models in the schema.prisma and update the schema with the changes
   -  `npx prisma migrate dev`
  This does two things: (1) pushes SQL schema to the database (2) run generate command and creates TypeScript types for the schema. 

  - View your fresh DB in Prisma Studio:
  - `npx prisma studio`

4. Create a module to encapsulate the calls to the DB. This way only certain modules will have access to the database. 
    - Create a module called prisma
    - in prisma.service extend the class to PrismaClient
    - Add the needed metadata to super() like the db url
    - In prisma.module make sure to `exports: [PrismaService]` to make it accessible
    - If you want to make the Prisma module available to all modules add the `@Global()` to prisma.module
    - Now you can import this module, wherever it is imported -- that module.service can use dependency injection to get reference to that imported module's service.  
  
*  ex/ auth.module/ *
  ` @Module({
  imports: [PrismaModule],
  controllers: [AuthController],
  providers: [AuthService],
}) `

5. Auth Validations for DTO:
  - `yarn add class-validator class-transformer`
  - see DTO folder for more details (this is used as a Type for auth and added to main.ts as a global pipe)

   6. Bonus: Create a script to clean up and respawn docker db and apply prisma migrations to the DB
   `"db:dev:remove": "docker compose rm dev-db -s -f -v",
    "db:dev:up": "docker compose up dev-db -d",
    "prisma:dev:deploy":"prisma migrate deploy",
    "db:dev:restart": "yarn db:dev:remove && yarn db:dev:up && sleep 1 && yarn prisma:dev:deploy",
    `
   * Windows Users:* replace `sleep 1 `with `TIMEOUT 1`

6. Create a nestjs config file to keep DB url secure
   - `yarn add @nestjs/config`
   - app/module.ts add `  ConfigModule.forRoot({ isGlobal: true }),` so it automatically applies the `.env`
   - Inject it into src/prisma/prisma.service.ts: `constructor(config: ConfigService`) and inside the super: `  url: config.get('DATABASE_URL'),`



  ## Prisma Breakdown:

  ### prisma/
  - schema.prisma: Where models will be declared.
  - Important: for the `DATABASE_URL`, prisma will grab the nearest .env file to it. 


### To seed dev db: 
- `npx prisma db seed`
- ``npx prisma studio``
   